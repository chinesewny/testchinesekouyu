<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบสอบอ่านภาษาจีน - ChineseClass By Krukong</title>
    <link rel="icon" href="https://img2.pic.in.th/pic/Logoc404dc85753b800c.png">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@400;700&display=swap');
        
        body { 
            font-family: 'Sarabun', sans-serif; 
            background-color: #f3f4f6; 
        }
        .chinese-font { 
            font-family: 'Noto Sans SC', sans-serif; 
        }
        .fade-in { 
            animation: fadeIn 0.5s ease-in-out; 
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ตั้งค่า Google Apps Script URL ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwcJVlj83Zat_Ew5EZ7A_0eaKUICk3L3p6qqvyNXuz85yrpURIy6yn4hm3xoc6dozKQ/exec"; 

        // --- Components ---

        const AlertModal = ({ message, type = 'error', onClose }) => {
            if (!message) return null;
            const isSuccess = type === 'success';
            const isWarning = type === 'warning';
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 animate-fade-in">
                    <div className="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4 transform transition-all scale-100">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className={`text-xl font-bold flex items-center ${isSuccess ? 'text-green-600' : isWarning ? 'text-yellow-600' : 'text-red-600'}`}>
                                <span className={`${isSuccess ? 'bg-green-100' : isWarning ? 'bg-yellow-100' : 'bg-red-100'} p-1 rounded-full mr-2`}>
                                    <i className={`ph-fill ${isSuccess ? 'ph-check-circle' : 'ph-warning-circle'} icon-md`}></i>
                                </span>
                                {isSuccess ? 'สำเร็จ' : isWarning ? 'แจ้งเตือน' : 'ข้อผิดพลาด'}
                            </h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                                <i className="ph ph-x icon-lg"></i>
                            </button>
                        </div>
                        <p className="text-gray-700 mb-6 text-lg">{message}</p>
                        <button 
                            onClick={onClose} 
                            className={`w-full text-white py-3 rounded-lg font-bold transition-colors shadow-md ${isSuccess ? 'bg-green-600 hover:bg-green-700' : isWarning ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-red-600 hover:bg-red-700'}`}
                        >
                            ตกลง
                        </button>
                    </div>
                </div>
            );
        };

        const Header = () => (
            <div className="bg-white shadow-md p-4 mb-6 rounded-xl flex flex-col items-center justify-center text-center border-b-4 border-red-500 relative overflow-hidden">
                <img 
                    src="https://img2.pic.in.th/pic/Logoc404dc85753b800c.png" 
                    alt="School Logo" 
                    className="h-28 mb-2 object-contain hover:scale-105 transition-transform duration-300 drop-shadow-sm" 
                />
                <h1 className="text-2xl md:text-3xl font-bold text-red-800 tracking-wide">ChineseClass By Krukong</h1>
                <p className="text-gray-600">ระบบสุ่มประโยคสอบการอ่านรายบุคคล</p>
            </div>
        );

        const Footer = () => (
            <div className="mt-12 text-center text-sm text-gray-500 pb-4 border-t pt-4">
                พัฒนาระบบโดย ครูกีรติ ประสพพรรังสี - กลุ่มสาระการเรียนรู้ภาษาต่างประเทศ
            </div>
        );

        const LoadingScreen = () => (
            <div className="min-h-screen flex flex-col items-center justify-center bg-indigo-50 text-indigo-800">
                <i className="ph ph-spinner ph-spin text-5xl mb-4"></i>
                <p className="text-xl font-medium">กำลังเชื่อมต่อฐานข้อมูล...</p>
                <p className="text-sm text-indigo-400 mt-2">กรุณารอสักครู่</p>
            </div>
        );

        const App = () => {
            const [step, setStep] = useState('loading'); // loading, login, check_result, select, exam, finish, teacher
            const [studentId, setStudentId] = useState('');
            const [studentName, setStudentName] = useState('');
            const [selectedSubject, setSelectedSubject] = useState('');
            const [randomPool, setRandomPool] = useState([]);
            const [selectedSentences, setSelectedSentences] = useState([]);
            
            // Score State
            const [sentenceScores, setSentenceScores] = useState({0:0, 1:0, 2:0, 3:0, 4:0});
            
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [alertState, setAlertState] = useState({ message: null, type: 'error' }); // type: error, success, warning
            const [showPinyin, setShowPinyin] = useState(false);
            
            // Database State
            const [dbStudents, setDbStudents] = useState({});
            const [dbSentences, setDbSentences] = useState({});
            
            // Results State
            const [allResults, setAllResults] = useState(() => {
                const saved = localStorage.getItem('chineseExamResults');
                return saved ? JSON.parse(saved) : {};
            });
            
            // Offline Queue State (New Feature)
            const [offlineQueue, setOfflineQueue] = useState(() => {
                const saved = localStorage.getItem('chineseExamQueue');
                return saved ? JSON.parse(saved) : [];
            });
            
            const [previousResult, setPreviousResult] = useState(null);

            const inputRef = useRef(null);

            const totalScore = useMemo(() => {
                return Object.values(sentenceScores).reduce((acc, curr) => acc + curr, 0);
            }, [sentenceScores]);

            // Fetch Data on Load
            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const [studentsRes, sentencesRes, subjectsRes, resultsRes] = await Promise.all([
                            fetch(`${GOOGLE_SCRIPT_URL}?action=getStudents`).then(res => res.json()),
                            fetch(`${GOOGLE_SCRIPT_URL}?action=getSentences`).then(res => res.json()),
                            fetch(`${GOOGLE_SCRIPT_URL}?action=getSubjects`).then(res => res.json()),
                            fetch(`${GOOGLE_SCRIPT_URL}?action=getResults`).then(res => res.json()).catch(() => []) 
                        ]);

                        const subjectMap = {};
                        if (Array.isArray(subjectsRes)) {
                            subjectsRes.forEach(subj => {
                                subjectMap[subj.code] = subj;
                            });
                        }

                        const enhancedSentences = { ...sentencesRes };
                        Object.keys(enhancedSentences).forEach(key => {
                            if (subjectMap[key]) {
                                enhancedSentences[key].name = subjectMap[key].name;
                            }
                        });
                        
                        const serverResults = {};
                        if (Array.isArray(resultsRes)) {
                            resultsRes.forEach(r => {
                                if (r.studentId) {
                                    serverResults[r.studentId] = { 
                                        score: r.score, 
                                        timestamp: r.timestamp 
                                    };
                                }
                            });
                        }

                        setAllResults(prev => ({ ...prev, ...serverResults }));
                        setDbStudents(studentsRes);
                        setDbSentences(enhancedSentences);
                        setStep('login');

                    } catch (error) {
                        console.error("Error loading data:", error);
                        setAlertState({
                            message: "ไม่สามารถโหลดข้อมูลจาก Server ได้ กรุณาตรวจสอบอินเทอร์เน็ต", 
                            type: 'error'
                        });
                    }
                };

                fetchData();
            }, []);

            useEffect(() => {
                localStorage.setItem('chineseExamResults', JSON.stringify(allResults));
            }, [allResults]);

            // Save Offline Queue to LocalStorage
            useEffect(() => {
                localStorage.setItem('chineseExamQueue', JSON.stringify(offlineQueue));
            }, [offlineQueue]);

            useEffect(() => {
                if (step === 'login' && inputRef.current) {
                    inputRef.current.focus();
                }
            }, [step]);

            const showAlert = (msg, type = 'error') => setAlertState({ message: msg, type: type });
            const closeAlert = () => setAlertState({ message: null, type: 'error' });

            const handleScan = (e) => {
                if (e.key === 'Enter') {
                    const id = studentId.trim();
                    if (id !== '') {
                        const studentData = dbStudents[id];

                        if (studentData) {
                            setStudentName(studentData.name);
                            const subjectKey = studentData.subject;

                            if (dbSentences[subjectKey]) {
                                setSelectedSubject(subjectKey);
                                
                                const prevRes = allResults[id];
                                if (prevRes) {
                                    setPreviousResult(prevRes);
                                    setStep('check_result'); 
                                } else {
                                    setPreviousResult(null);
                                    generateSentences(subjectKey);
                                }
                            } else {
                                showAlert(`พบข้อมูลนักเรียน แต่ไม่พบรายวิชา ${subjectKey} ในระบบข้อสอบ`);
                            }
                        } else {
                            showAlert("ไม่พบรหัสนักเรียนนี้ในระบบ หรือยังไม่ได้ลงทะเบียนรายวิชา");
                            setStudentId('');
                        }
                    } else {
                        showAlert("กรุณาสแกนรหัสหรือกรอกรหัสนักเรียน");
                    }
                }
            };

            const startExam = () => {
                generateSentences(selectedSubject);
            };

            const generateSentences = (subjectKey) => {
                const subjectData = dbSentences[subjectKey];
                if (!subjectData) return;

                const allSentences = [...subjectData.sentences];
                for (let i = allSentences.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [allSentences[i], allSentences[j]] = [allSentences[j], allSentences[i]];
                }
                
                setRandomPool(allSentences.slice(0, 10));
                setStep('select');
            };

            const toggleSentence = (sentence) => {
                if (selectedSentences.includes(sentence)) {
                    setSelectedSentences(selectedSentences.filter(s => s !== sentence));
                } else {
                    if (selectedSentences.length < 5) {
                        setSelectedSentences([...selectedSentences, sentence]);
                    } else {
                        showAlert("เลือกได้สูงสุด 5 ประโยคเท่านั้น");
                    }
                }
            };
            
            const updateSentenceScore = (index, scoreValue) => {
                setSentenceScores(prev => ({
                    ...prev,
                    [index]: scoreValue
                }));
            };

            const saveData = async () => {
                setIsSubmitting(true);
                const timestamp = new Date().toLocaleString('th-TH');
                const currentStudent = dbStudents[studentId];

                // Data Payload (Full detail)
                const dataPayload = {
                    studentId: studentId,
                    studentName: studentName,
                    subject: selectedSubject,
                    room: currentStudent.room,
                    no: currentStudent.no,
                    selectedSentences: selectedSentences.join(" || "),
                    score: totalScore,
                    timestamp: timestamp
                };

                // Update Local Results (for immediate feedback check)
                setAllResults(prev => ({
                    ...prev,
                    [studentId]: { score: totalScore, timestamp: timestamp }
                }));

                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(dataPayload)
                    });
                    // If successful, we don't need to do anything else.
                } catch (error) {
                    console.error("Error saving to Google Sheets, saving locally", error);
                    // Add to Offline Queue
                    setOfflineQueue(prev => [...prev, dataPayload]);
                    showAlert("ไม่สามารถเชื่อมต่อ Server ได้ ระบบได้บันทึกข้อมูลแบบ Offline ไว้แล้ว กรุณาไปที่หน้าครูเพื่อกด 'Sync Data' เมื่อมีอินเทอร์เน็ต", "warning");
                }

                setTimeout(() => {
                    setStep('finish');
                    setIsSubmitting(false);
                }, 1000);
            };

            const resetSystem = () => {
                setStudentId('');
                setStudentName('');
                setSelectedSubject('');
                setRandomPool([]);
                setSelectedSentences([]);
                setSentenceScores({0:0, 1:0, 2:0, 3:0, 4:0});
                setPreviousResult(null);
                setStep('login');
                setShowPinyin(false);
            };

            const renderSentence = (text) => {
                const regex = /(\s*\([^)]*\))/g;
                if (!showPinyin) {
                    return text.replace(regex, '');
                }
                const parts = text.split(regex);
                return parts.map((part, i) => {
                    if (part.match(regex)) {
                        return <span key={i} className="text-indigo-600 font-normal ml-1">{part}</span>;
                    }
                    return part;
                });
            };

            const getUniqueRooms = () => {
                const rooms = new Set();
                Object.values(dbStudents).forEach(s => rooms.add(s.room));
                return Array.from(rooms).sort();
            };

            const TeacherDashboard = () => {
                const [selectedRoom, setSelectedRoom] = useState('');
                const [syncing, setSyncing] = useState(false);
                const rooms = getUniqueRooms();

                const exportCSV = () => {
                    if (!selectedRoom) return;

                    const roomStudents = Object.entries(dbStudents)
                        .filter(([_, data]) => data.room === selectedRoom)
                        .sort((a, b) => parseInt(a[1].no) - parseInt(b[1].no));

                    let csvContent = "data:text/csv;charset=utf-8,";
                    csvContent += "ลำดับที่,รหัสนักเรียน,ชื่อ-นามสกุล,คะแนนที่ได้\n";

                    roomStudents.forEach(([id, data]) => {
                        const result = allResults[id];
                        const scoreStr = result ? result.score : "";
                        const safeName = `"${data.name.replace(/"/g, '""')}"`;
                        csvContent += `${data.no},${id},${safeName},${scoreStr}\n`;
                    });

                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `คะแนนสอบอ่าน_${selectedRoom}_${new Date().toISOString().slice(0,10)}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };

                // Function to Sync Offline Data
                const syncData = async () => {
                    if (offlineQueue.length === 0) return;
                    setSyncing(true);
                    
                    let successCount = 0;
                    let failedQueue = [];

                    for (const data of offlineQueue) {
                        try {
                            await fetch(GOOGLE_SCRIPT_URL, {
                                method: 'POST',
                                mode: 'no-cors',
                                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                                body: JSON.stringify(data)
                            });
                            // Delay slightly to prevent rate limiting
                            await new Promise(r => setTimeout(r, 500));
                            successCount++;
                        } catch (error) {
                            console.error("Sync failed for:", data.studentName, error);
                            failedQueue.push(data);
                        }
                    }

                    setOfflineQueue(failedQueue);
                    setSyncing(false);
                    
                    if (failedQueue.length === 0) {
                        showAlert(`ซิงค์ข้อมูลสำเร็จทั้งหมด ${successCount} รายการ`, 'success');
                    } else {
                        showAlert(`ซิงค์สำเร็จ ${successCount} รายการ, ล้มเหลว ${failedQueue.length} รายการ (ลองใหม่อีกครั้ง)`, 'warning');
                    }
                };

                return (
                    <div className="min-h-screen p-4 max-w-4xl mx-auto flex flex-col">
                        <Header />
                        <div className="bg-white p-6 rounded-xl shadow-lg fade-in">
                            <div className="flex justify-between items-center mb-6 border-b pb-4">
                                <h2 className="text-2xl font-bold text-gray-800 flex items-center">
                                    <i className="ph ph-gear mr-2"></i> ระบบจัดการครูผู้สอน
                                </h2>
                                <button onClick={() => setStep('login')} className="text-gray-500 hover:text-red-500">
                                    <i className="ph ph-x icon-lg"></i>
                                </button>
                            </div>

                            {/* Offline Data Sync Section */}
                            <div className="mb-8 bg-orange-50 p-4 rounded-xl border border-orange-200">
                                <h3 className="text-lg font-bold text-orange-800 mb-2 flex items-center">
                                    <i className="ph ph-cloud-warning mr-2"></i> ข้อมูลรอการซิงค์ (Offline Data)
                                </h3>
                                <div className="flex justify-between items-center">
                                    <div>
                                        <p className="text-gray-600">
                                            มีข้อมูลค้างอยู่ในเครื่อง: <span className="font-bold text-lg">{offlineQueue.length}</span> รายการ
                                        </p>
                                        <p className="text-xs text-gray-400">ข้อมูลเหล่านี้บันทึกตอนไม่มีอินเทอร์เน็ต</p>
                                    </div>
                                    <button 
                                        onClick={syncData}
                                        disabled={offlineQueue.length === 0 || syncing}
                                        className={`px-6 py-2 rounded-lg font-bold text-white flex items-center shadow-md transition-all ${offlineQueue.length > 0 ? 'bg-orange-500 hover:bg-orange-600' : 'bg-gray-300 cursor-not-allowed'}`}
                                    >
                                        {syncing ? (
                                            <><i className="ph ph-spinner animate-spin mr-2"></i> กำลังซิงค์...</>
                                        ) : (
                                            <><i className="ph ph-cloud-arrow-up mr-2"></i> Sync Data Now</>
                                        )}
                                    </button>
                                </div>
                            </div>

                            <div className="mb-8">
                                <label className="block text-gray-700 font-bold mb-2">เลือกห้องเรียนที่ต้องการส่งออกข้อมูล (CSV):</label>
                                <div className="flex gap-4">
                                    <select 
                                        value={selectedRoom}
                                        onChange={(e) => setSelectedRoom(e.target.value)}
                                        className="flex-1 p-3 border rounded-lg text-lg bg-gray-50 focus:ring-2 focus:ring-blue-400 outline-none"
                                    >
                                        <option value="">-- กรุณาเลือกห้อง --</option>
                                        {rooms.map(r => <option key={r} value={r}>{r}</option>)}
                                    </select>
                                    
                                    <button 
                                        onClick={exportCSV}
                                        disabled={!selectedRoom}
                                        className={`px-6 py-3 rounded-lg font-bold text-white flex items-center shadow-md transition-all ${selectedRoom ? 'bg-green-600 hover:bg-green-700 hover:-translate-y-1' : 'bg-gray-300 cursor-not-allowed'}`}
                                    >
                                        <i className="ph ph-download-simple mr-2"></i> Export CSV
                                    </button>
                                </div>
                            </div>
                        </div>
                        <Footer />
                    </div>
                );
            };

            if (step === 'loading') {
                return <LoadingScreen />;
            }

            return (
                <div className="font-sans text-gray-900 bg-gray-50 min-h-screen">
                    <AlertModal 
                        message={alertState.message} 
                        type={alertState.type}
                        onClose={closeAlert} 
                    />
                    
                    {/* Step 1: Login */}
                    {step === 'login' && (
                        <div className="min-h-screen p-4 max-w-2xl mx-auto flex flex-col">
                            <Header />
                            <div className="flex-grow flex flex-col justify-center items-center bg-white p-8 rounded-xl shadow-lg fade-in relative overflow-hidden">
                                <button 
                                    onClick={() => setStep('teacher')}
                                    className="absolute top-4 right-4 text-gray-300 hover:text-gray-600 transition-colors z-20 p-2"
                                    title="สำหรับครู"
                                >
                                    <i className="ph ph-gear icon-md"></i>
                                </button>

                                <div className="bg-red-100 p-4 rounded-full mb-4 z-10 animate-bounce">
                                    <i className="ph ph-scan text-red-600 icon-xl"></i>
                                </div>
                                <h2 className="text-xl font-bold mb-4 z-10">สแกนรหัสนักเรียน / Scan ID</h2>
                                <input 
                                    ref={inputRef}
                                    type="text" 
                                    value={studentId}
                                    onChange={(e) => setStudentId(e.target.value)}
                                    onKeyDown={handleScan}
                                    placeholder="ยิงบาร์โค้ดที่นี่..."
                                    className="w-full text-center text-2xl p-4 border-2 border-red-300 rounded-lg focus:outline-none focus:border-red-600 focus:ring-4 focus:ring-red-100 transition mb-4 z-10 placeholder-gray-300"
                                />
                                <div className="text-sm text-gray-500 mt-2 z-10 text-center">
                                    <p>ระบบจะค้นหารายวิชาและชุดข้อสอบอัตโนมัติ</p>
                                    {offlineQueue.length > 0 && (
                                        <p className="text-orange-500 font-bold mt-2">
                                            <i className="ph-fill ph-warning-circle"></i> มีข้อมูลรอซิงค์ {offlineQueue.length} รายการ (แจ้งครู)
                                        </p>
                                    )}
                                </div>
                                
                                <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-red-500 via-yellow-400 to-red-500"></div>
                                <div className="absolute -bottom-10 -right-10 w-32 h-32 bg-red-50 rounded-full z-0 opacity-50"></div>
                                <div className="absolute -top-10 -left-10 w-32 h-32 bg-yellow-50 rounded-full z-0 opacity-50"></div>
                            </div>
                            <Footer />
                        </div>
                    )}
                    
                    {/* Step: Check Result */}
                    {step === 'check_result' && previousResult && (
                        <div className="min-h-screen p-4 max-w-2xl mx-auto flex flex-col">
                            <Header />
                            <div className="flex-grow flex flex-col justify-center items-center bg-white p-8 rounded-xl shadow-lg fade-in border-t-4 border-blue-500">
                                <div className="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                                    <i className="ph ph-user text-4xl text-gray-600"></i>
                                </div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-1">{studentName}</h2>
                                <p className="text-gray-500 mb-6">รหัสนักเรียน: {studentId}</p>
                                
                                <div className={`p-6 rounded-xl w-full text-center mb-6 ${previousResult.score < 6 ? 'bg-red-50 border border-red-200' : 'bg-green-50 border border-green-200'}`}>
                                    <p className="text-gray-600 mb-2">ผลการสอบล่าสุด</p>
                                    <div className={`text-4xl font-bold mb-2 ${previousResult.score < 6 ? 'text-red-600' : 'text-green-600'}`}>
                                        {previousResult.score} / 10
                                    </div>
                                    <div className="text-sm text-gray-500">
                                        {previousResult.score < 6 ? 'ยังไม่ผ่านเกณฑ์ (น้อยกว่า 6)' : 'ผ่านเกณฑ์เรียบร้อย'}
                                    </div>
                                </div>
                                
                                <div className="w-full space-y-3">
                                    {previousResult.score < 6 ? (
                                        <button 
                                            onClick={startExam}
                                            className="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-bold text-lg shadow-md transition-colors flex items-center justify-center gap-2"
                                        >
                                            <i className="ph-bold ph-arrow-clockwise"></i> สอบแก้ตัวใหม่
                                        </button>
                                    ) : (
                                        <div className="text-center p-2 text-gray-400 text-sm">
                                            นักเรียนสอบผ่านแล้ว
                                        </div>
                                    )}
                                    
                                    <button 
                                        onClick={resetSystem}
                                        className="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 py-3 rounded-lg font-medium transition-colors"
                                    >
                                        กลับไปหน้าหลัก
                                    </button>
                                    
                                    {previousResult.score >= 6 && (
                                        <button 
                                            onClick={startExam}
                                            className="w-full mt-2 text-gray-400 hover:text-red-500 text-xs py-2 underline"
                                        >
                                            (สำหรับครู) บังคับสอบใหม่
                                        </button>
                                    )}
                                </div>
                            </div>
                            <Footer />
                        </div>
                    )}

                    {/* Step: Teacher Dashboard */}
                    {step === 'teacher' && <TeacherDashboard />}

                    {/* Step 2: Select Sentences */}
                    {step === 'select' && (
                        <div className="min-h-screen p-4 max-w-4xl mx-auto flex flex-col">
                            <Header />
                            <div className="bg-white p-6 rounded-xl shadow-lg fade-in border-t-4 border-yellow-400">
                                <div className="flex flex-col md:flex-row justify-between items-center mb-6 border-b pb-4 gap-4 bg-gray-50 p-4 rounded-lg">
                                    <div>
                                        <h2 className="text-xl font-bold text-red-800 flex items-center">
                                            <i className="ph ph-user mr-2 text-red-500"></i> {studentName} 
                                            <span className="ml-2 text-sm font-normal text-gray-500 bg-white px-2 py-1 rounded border">ID: {studentId}</span>
                                        </h2>
                                        <div className="flex gap-4 mt-1 text-sm text-gray-600">
                                            <span className="flex items-center">
                                                <i className="ph ph-book-open mr-1 icon-sm"></i> {dbSentences[selectedSubject]?.name || selectedSubject}
                                            </span>
                                            <span className="flex items-center">
                                                <i className="ph ph-users mr-1 icon-sm"></i> ห้อง: {dbStudents[studentId].room} (เลขที่ {dbStudents[studentId].no})
                                            </span>
                                        </div>
                                    </div>
                                    <div className={`font-bold px-4 py-2 rounded-full flex items-center shadow-sm transition-colors ${selectedSentences.length === 5 ? 'bg-green-100 text-green-700 ring-2 ring-green-400' : 'bg-yellow-100 text-yellow-700'}`}>
                                        <i className="ph ph-check-square mr-2 icon-md"></i> เลือกแล้ว {selectedSentences.length} / 5
                                    </div>
                                </div>

                                <p className="mb-4 text-gray-600 text-center font-medium">✨ กรุณาเลือกประโยคที่ต้องการสอบจำนวน 5 ประโยค ✨</p>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mb-8">
                                    {randomPool.map((sentence, index) => (
                                        <div 
                                            key={index}
                                            onClick={() => toggleSentence(sentence)}
                                            className={`p-4 border-2 rounded-xl cursor-pointer transition-all duration-200 flex items-center relative overflow-hidden ${selectedSentences.includes(sentence) ? 'border-red-500 bg-red-50 shadow-md transform scale-[1.01]' : 'border-gray-100 hover:border-red-200 hover:bg-gray-50 hover:shadow-sm'}`}
                                        >
                                            <div className={`w-6 h-6 rounded-full border-2 mr-4 flex items-center justify-center flex-shrink-0 transition-colors ${selectedSentences.includes(sentence) ? 'bg-red-500 border-red-500 text-white' : 'border-gray-300 bg-white'}`}>
                                                {selectedSentences.includes(sentence) && <i className="ph-bold ph-check text-xs"></i>}
                                            </div>
                                            <span className="text-lg chinese-font text-gray-800">
                                                {renderSentence(sentence)}
                                            </span>
                                            {selectedSentences.includes(sentence) && <div className="absolute right-0 top-0 w-4 h-full bg-gradient-to-l from-red-100 to-transparent opacity-50"></div>}
                                        </div>
                                    ))}
                                </div>

                                <div className="flex justify-between mt-4">
                                    <button onClick={resetSystem} className="px-6 py-3 rounded-lg text-gray-500 hover:text-red-600 hover:bg-red-50 transition-colors">
                                        ยกเลิก / เปลี่ยนคน
                                    </button>
                                    <button 
                                        disabled={selectedSentences.length !== 5}
                                        onClick={() => setStep('exam')}
                                        className={`px-10 py-3 rounded-xl font-bold text-white shadow-lg transition-all transform flex items-center ${selectedSentences.length === 5 ? 'bg-gradient-to-r from-red-600 to-red-500 hover:from-red-700 hover:to-red-600 hover:scale-105 hover:shadow-xl' : 'bg-gray-300 cursor-not-allowed grayscale'}`}
                                    >
                                        ยืนยันและเริ่มสอบ <span className="ml-2">➜</span>
                                    </button>
                                </div>
                            </div>
                            <Footer />
                        </div>
                    )}

                    {/* Step 3: Exam & Grading */}
                    {step === 'exam' && (
                        <div className="min-h-screen p-4 max-w-4xl mx-auto flex flex-col">
                            <Header />
                            <div className="bg-white p-6 rounded-xl shadow-lg fade-in relative">
                                <div className="flex flex-col md:flex-row justify-between items-start mb-6 border-b pb-4">
                                    <div>
                                        <h2 className="text-2xl font-bold text-red-800 mb-1 flex items-center">
                                            <i className="ph ph-file-text mr-2"></i> หน้าสอบอ่าน
                                        </h2>
                                        <p className="text-lg font-bold text-gray-800 flex items-center mt-2">
                                            <i className="ph ph-user mr-2 text-gray-500 icon-md"></i> {studentName}
                                        </p>
                                        <p className="text-gray-500 ml-7 text-sm">{dbSentences[selectedSubject]?.name || selectedSubject}</p>
                                    </div>
                                    <div className="text-right mt-4 md:mt-0">
                                        <div className="bg-gray-50 p-3 rounded-lg border border-gray-100 mb-2">
                                            <div className="text-xs text-gray-400 uppercase tracking-wider mb-1">Date</div>
                                            <div className="font-mono font-bold text-gray-700">{new Date().toLocaleDateString('th-TH')}</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="flex justify-end mb-2">
                                    <button
                                        onClick={() => setShowPinyin(!showPinyin)}
                                        className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm transition-colors border ${showPinyin ? 'bg-green-50 border-green-200 text-green-700' : 'bg-gray-100 border-gray-200 text-gray-500'}`}
                                    >
                                        {showPinyin ? <i className="ph-fill ph-toggle-right text-xl"></i> : <i className="ph-fill ph-toggle-left text-xl"></i>}
                                        <span>{showPinyin ? "แสดงพินอิน (เปิด)" : "แสดงพินอิน (ปิด)"}</span>
                                    </button>
                                </div>

                                <div className="space-y-4 mb-8">
                                    {selectedSentences.map((sentence, index) => (
                                        <div key={index} className="flex flex-col md:flex-row items-center bg-white p-4 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow gap-4">
                                            <div className="flex items-start flex-grow w-full">
                                                <span className="bg-red-600 text-white font-bold rounded-full w-8 h-8 flex items-center justify-center mr-4 flex-shrink-0 shadow-sm text-sm">
                                                    {index + 1}
                                                </span>
                                                <p className="text-xl md:text-2xl chinese-font text-gray-800 leading-relaxed font-medium">
                                                    {renderSentence(sentence)}
                                                </p>
                                            </div>

                                            <div className="flex items-center gap-1 bg-gray-50 p-2 rounded-lg border border-gray-200 flex-shrink-0">
                                                {[0, 1, 2].map(scoreVal => (
                                                    <button
                                                        key={scoreVal}
                                                        onClick={() => updateSentenceScore(index, scoreVal)}
                                                        className={`w-10 h-10 rounded-md font-bold text-lg transition-all ${sentenceScores[index] === scoreVal ? 
                                                            (scoreVal === 2 ? 'bg-green-500 text-white shadow-md' : scoreVal === 1 ? 'bg-yellow-500 text-white shadow-md' : 'bg-red-500 text-white shadow-md') 
                                                            : 'bg-white text-gray-400 border border-gray-200 hover:bg-gray-100'}`}
                                                    >
                                                        {scoreVal}
                                                    </button>
                                                ))}
                                                <span className="ml-1 text-xs text-gray-400 font-medium">คะแนน</span>
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <div className="border-t-2 border-dashed border-gray-200 pt-6 bg-gray-50 p-6 rounded-xl -mx-2 md:mx-0 sticky bottom-0 shadow-inner">
                                    <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                                        <div>
                                            <h3 className="text-lg font-bold flex items-center text-gray-700">
                                                <i className="ph ph-calculator mr-2 text-indigo-600"></i> สรุปคะแนนสอบ
                                            </h3>
                                            <p className="text-sm text-gray-500">ระบบคำนวณจากคะแนนรายข้อ (ข้อละ 2 คะแนน)</p>
                                        </div>
                                        
                                        <div className="flex items-center gap-6">
                                            <div className="text-center">
                                                <div className="text-4xl font-bold text-indigo-700">{totalScore}</div>
                                                <div className="text-xs text-gray-500 uppercase">Total Score</div>
                                            </div>
                                            <div className={`px-4 py-2 rounded-lg font-bold text-lg ${totalScore >= 6 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                {totalScore >= 6 ? 'ผ่านเกณฑ์' : 'ควรปรับปรุง'}
                                            </div>
                                        </div>

                                        <button 
                                            onClick={saveData}
                                            disabled={isSubmitting}
                                            className={`w-full md:w-auto px-8 py-3 text-white text-lg rounded-xl font-bold shadow-lg flex items-center justify-center transition-all ${isSubmitting ? 'bg-gray-400 cursor-wait' : 'bg-green-600 hover:bg-green-700 hover:shadow-green-200 hover:-translate-y-1'}`}
                                        >
                                            {isSubmitting ? (
                                                <span className="flex items-center"><i className="ph ph-spinner animate-spin mr-2"></i> กำลังบันทึก...</span>
                                            ) : (
                                                <>
                                                    <i className="ph ph-floppy-disk mr-2"></i> บันทึกผล
                                                </>
                                            )}
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <Footer />
                        </div>
                    )}

                    {/* Step 4: Success */}
                    {step === 'finish' && (
                        <div className="min-h-screen p-4 flex flex-col items-center justify-center bg-gradient-to-br from-green-50 to-blue-50">
                            <div className="bg-white p-10 rounded-2xl shadow-2xl text-center fade-in max-w-md w-full border-t-8 border-green-500 transform transition-all">
                                <div className="mx-auto bg-green-100 w-24 h-24 rounded-full flex items-center justify-center mb-6 animate-pulse">
                                    <i className="ph-fill ph-check-circle text-green-600 text-6xl"></i>
                                </div>
                                <h2 className="text-3xl font-bold text-gray-800 mb-2">บันทึกเรียบร้อย!</h2>
                                <div className="w-16 h-1 bg-green-200 mx-auto mb-4 rounded-full"></div>
                                <p className="text-gray-600 mb-1">ผลสอบของ</p>
                                <p className="text-xl font-bold text-green-700 mb-8 bg-green-50 py-2 rounded-lg">{studentName}</p>
                                <div className="mt-4 text-gray-500">
                                    คะแนนที่ได้: <span className="font-bold text-gray-800">{totalScore} / 10</span>
                                </div>
                                
                                <button 
                                    onClick={resetSystem}
                                    className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 flex items-center justify-center shadow-lg transition-transform hover:scale-105 active:scale-95 mt-8"
                                >
                                    <i className="ph ph-arrow-counter-clockwise mr-2"></i> กลับไปหน้าแรก (คนถัดไป)
                                </button>
                            </div>
                            <Footer />
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
